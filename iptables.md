## Настройка Linux-файрвола Iptables


**Iptables** - это межсетевой экран для операционных систем Linux. Успешно применять этот инструмент могут не только продвинутые пользователи Linux, но и новички. В этой статье представлено описание базовых настроек конфигурации этого мощного файрвола.


### Что такое iptables?

Как сказано выше, iptables является утилитой, выполняющей функции межсетевого экрана. Ее настройка производится в командной строке, с помощью правил iptables можно разрешать или блокировать прохождение трафика. Когда происходит попытка установления соединения с текущей машиной, iptables просматривает список правил в списке, чтобы понять, как нужно поступить в этом случае. Если правила нет, то выполняется действие по умолчанию.  

Как правило, itpables предустанавливается на всех Linux-дистрибутивах. Чтобы обновить утилиту, или установить ее, если по каким-то причинам она отсутствует в базовой поставке, нужно воспользоваться следующей командой:  
```bash
sudo apt-get install iptables
```
Существуют и графические инструменты-альтернативы iptables, например Firestarter, но и работа в командной строке не является очень уж сложной. Однако следует соблюдать особенную осторожность при настройке iptables через удаленное ssh-соединение, поскольку одна неверная команда может заблокировать возможность подключения к удаленному серверу - придется каким-то образом вносить изменения в настройки машины физически получив к ней доступ.  


### Типы правил

Существует три типа правил iptables - input, forward и output.  

**Input** - такие цепочки используются для контроля поведения входящих соединений. К примеру, если пользователь попробует подключиться к серверу по SSH, то iptables сравнит его IP-адрес со своим списком, чтобы разрешить или запретить доступ.  

**Forward** - правила этого типа используются для обработки входящих сообщений, конечный пункт назначения которых не является текущим сервером. К примеру, в случае маршрутизатора, к нему подключаются многие пользователи и приложения, но данные не посылаются на сам маршрутизатор, они лишь передаются ему, чтобы он мог перенаправить их адресату. Если вы не занимаетесь настройкой маршрутизации или NAT, то правила этого типа использовать в работе не будете.  

**Output** - такие цепочки используются для исходящих соединений. К прмиеру, если пользователь пытается отправить запрос ping к сайту 1cloud.ru, iptables изучит цепочку правил, чтобы понять, что нужно делать в случае ping и этого сайт, и только потом разрешит или запретит соединение.  

Важный момент: Даже в случае пинга внешних хостов, нужно не только отправить пакеты к ним, но и получить ответ. При работе с iptables важно помнить, что многие протоколы передачи данных требуют двусторонней коммуникации. Поэтому нужно настраивать правила соответствующим образом - случаи, когда новички забывают разрешить работу с сервером по SSH случаются очень часто.  


### Поведение по умолчанию

Прежде чем приступать к непосредственной настройке межсетевого экрана, следует определиться с тем, каким должно быть поведение цепочек правил по умолчанию. Другими словами, что iptables нужно делать в том случае, если соединение не подпадает ни под одно из сконфигурированных правил?  

Увидеть текущие настройки iptables по умолчанию можно с помощью команды:  
```bash
iptables –L
```
<img src="https://ask42.us/static/computer_networks/iptables_default_settings.8657539b86fe.jpg" alt="Настройки iptables по умолчанию">

В данном случае мы также использовали команду grep, чтобы получить более четкий вывод. Как показано на скриншоте, все три цепочки по умолчанию разрешают прием трафика. Чаще всего такое поведение более предпочтительно. Если вы ничего не меняли в правилах, то так оно и должно быть по умолчанию. Если же что-то менялось, а теперь нужно вернуть прежние настройки, то сделать это можно с помощью таких команд:  
```bash
iptables --policy INPUT ACCEPT
```
```bash
iptables --policy OUTPUT ACCEPT
```
```bahs
iptables –-policy FORWARD ACCEPT
```
Предварительно разрешив весь трафик, затем уже можно запрещать соединения с определенных IP-адресов и на определенные порты.  

Если же предпочтительнее пойти по другому пути и сначала запретить весь трафик, а затем выборочно разрешать его, то нужно воспользоваться командами из списка ниже:  
```bash
iptables --policy INPUT DROP
```
```bash
iptables --policy OUTPUT DROP
```
```bash
iptables –-policy FORWARD DROP
```

## Действия с соединениями

После настройки поведения межсетевого экрана по умолчанию, можно переходить к созданию правил обработки трафика, чтобы iptables понимал, что делать с конкретным соединением. Ниже мы рассмотрим три основных вида действий с соединениями.  

- **Accept** - разрешить соединение;
- **Drop** - игнорировать соединение, вести себя так, будто его никогда не было. Действие подходит для случаев, когда нужно сделать так, чтобы источник запроса не узнал о его блокировке.
- **Reject** - заблокировать соединение и отправить в ответ сообщение об ошибке. Действие подходит для тех случаев, когда владелец сервера хочет дать понять, что соединение заблокировано файрволом.

Вот так выглядит ответ на пинг в каждом из трех случаев:

Соединение разрешено:  
<img src="https://ask42.us/static/computer_networks/accept.d609ecc5b1d0.jpg" alt="Соединение разрешено">

Соединение проигнорировано:  
<img src="https://ask42.us/static/computer_networks/drop.e4b229ba74ca.jpg" alt="Соединение проигнорировано">

Соединение отклонено:  
<img src="https://ask42.us/static/computer_networks/reject.d53383ad44d4.jpg" alt="Соединение отклонено">

### Разрешаем и блокируем конкретные соединения

Настроив политики цепочек, можно переходить к работе с конкретными соединениями. В нашем руководстве мы будем по умолчанию их отклонять, но можно и разрешать или игнорировать.  

Мы будем использовать команду iptables -A, чтобы добавлять правила к существующим цепочкам. Iptables будет начинать с начала списка и проходить по всем правилам, пока не найдет совпадение. Если нужно поместить какое-то правило перед уже имеющимся, то можно использовать команду iptables -I [цепочка] [номер], чтобы указать номер позиции в списке, которую должно занять новое правило.  


### Соединения с одного IP-адреса

Правило ниже позволяет заблокировать все соединения с IP-адреса 10.10.10.10:  
```bash
iptables -A INPUT -s 10.10.10.10 -j DROP
```
Правило ниже позволяет заблокировать соединения из диапазона IP-адресов 10.10.10.0/24. Для указания диапазона адресов можно использовать стандартную запись маски подсети через слэш или описывать ее в полном варианте:
```basg
iptables -A INPUT -s 10.10.10.0/24 -j DROP
```
или
```bash
iptables -A INPUT -s 10.10.10.0/255.255.255.0 -j DROP
```

### Соединения на конкретный порт

Ниже показано, как заблокировать SSH-соединения с хоста 10.10.10.10:  
```bash
iptables -A INPUT -p tcp --dport ssh -s 10.10.10.10 -j DROP
```
Вместо SSH можно указать любой протокол или номер порта. Часть кода -p tcp говорит iptables о типе соединения, которое использует протокол. Если вы блокировали протокол, который использует UDP вместо TCP, то тогда нужно ыло бы написать -p udp.  

Вот так можно заблокировать SSH-соединения с любого IP-адреса.  
```bahs
iptables -A INPUT -p tcp --dport ssh -j DROP
```

### Состояния соединений

Как сказано выше, многие протоколы требуют двусторонних коммуникаций. Например, если нужно разрешить соединения по SSH, то добавить правила надо будет и в цепочку input и в цепочку output. Но что, если нужно только разрешить доступ только входящим соединениям? Разрешит ли добавление правила в цепочку output и исходящие SSH-соединения?  

Для таких случаев используются состояния соединений. Они позволяют описывать двусторонние коммуникации, в которых разрешается установка только соединений определенной направленности. В примере ниже разрешены SSH-соединения, поступающие от хоста 10.10.10.10, но SSH-соединения к этому хосту запрещены. Однако, системе разрешается отправка информации по SSH в случае уже установленной сессии, что делает возможной SSH-коммуникацию между хостами:  
```bash
iptables -A INPUT -p tcp --dport ssh -s 10.10.10.10 -m state --state NEW,ESTABLISHED -j ACCEPT
```
```bash
iptables -A OUTPUT -p tcp --sport 22 -d 10.10.10.10 -m state --state ESTABLISHED -j ACCEPT
```

### Сохранение изменений

Внесенные в цепочки правил изменения пропадут при перезапуске iptables, так что их нужно сохранить с помощью специальной команды. В зависимости от используемого Linux-дистрибутива команда может выглядеть по-разному.  

Ubuntu:  
```bash
=sudo /sbin/iptables-save
```
Red Hat / CentOS:  
```bash
=/sbin/service iptables save
```
Или  
```bahs
=/etc/init.d/iptables save
```

### Другие команды

Вывод уже сконфигурированных правил iptables:  
```bash
iptables -L
```
Добавление ключа -v позволит просматривать информацию по пакетам и байтам, добавление -n выведет информацию в цифровом формате - имена хостов, протоколы и сети будут описаны цифрами.  

Для удаления всех сконфигурированных правил можно использовать такую команду:  
```bash
iptables -F
```
